@page "/scenario/1"
@attribute [Authorize]
@inject AudioService Audio
@inject NavigationManager Navigation
@inject ScenarioService Scenario
@inject IJSRuntime JS

<div class="scenario">
    <img src="img/sc1_normal.png" alt="" />
    <img class="glitch-img @ImageClass @TearClass" src="img/sc1_glitch.png" alt="" />

    <section class="contents card">
        <header>
            <h1>Kwaliteitsprotocol 7B</h1>
            <h3>Scenario 1 – Melkcontrole</h3>
            <h5>Routinecontrole – Silo 3</h5>
        </header>

        <article class="instructions">
            <p>Voer een visuele inspectie uit van de melkmonsters.</p>
            <p>Let op afwijkingen in kleur, temperatuur en lichtreflectie.</p>
            <p><strong>Monster #17</strong> toont een lichte UV‑afwijking. Noteer volgens protocol.</p>
        </article>

        @if (CurrentPhase >= ScenarioPhase.Question)
        {
            <section class="question">
                <p class="question-text">@((MarkupString)Question.Text)</p>
                <div class="answers">
                    @foreach (var answer in Question.Answers)
                    {
                        <button class="answer" @onclick="() => ProvideAnswer(answer)" @key="answer">
                            @((MarkupString)answer.Text)
                        </button>
                    }
                </div>

                @if (CurrentAnswer is { IsCorrect: false })
                {
                    <p class="invalid">Onjuist volgens Kwaliteitsprotocol 7B. Let op: afwijkende keuzes worden gelogd.</p>
                }
                else if (CurrentAnswer is { IsCorrect: true })
                {
                    <p class="valid">Correct volgens Kwaliteitsprotocol 7B.</p>
                }

                @if (CurrentPhase == ScenarioPhase.Results && CurrentAnswer is { IsCorrect: true })
                {
                    <div class="result-overlay">
                        <p class="result-number">@Question.ResultValue</p>
                    </div>
                }
            </section>
        }
        else
        {
            <button class="audio" @onclick="Play">Tik om door te gaan</button>
        }
    </section>
</div>

@code {
    public Answer? CurrentAnswer { get; private set; }
    public ScenarioPhase CurrentPhase { get; private set; } = ScenarioPhase.Idle;
    public string? ImageClass => CurrentPhase is ScenarioPhase.Glitch ? "active" : null;
    public string? TearClass { get; private set; }
    public Question Question { get; } = new("Welke parameter wijkt het meest af van de standaardwaarden?",
    [
        new("<strong>A.</strong> Vetpercentage"),
        new("<strong>B.</strong> Temperatuur"),
        new("<strong>C.</strong> UV‑reflectiepatroon", IsCorrect: true),
        new("<strong>D.</strong> pH‑waarde"),
    ], ResultValue: 9);

    public async Task Play()
    {
        CurrentPhase = ScenarioPhase.Question;
        StateHasChanged();

        await Task.Delay(1000);
        await Glitch();

        CurrentPhase = ScenarioPhase.Question;
        StateHasChanged();
    }

    public async Task ProvideAnswer(Answer answer)
    {
        CurrentAnswer = answer;
        if (answer.IsCorrect)
        {
            CurrentPhase = ScenarioPhase.Results;

            await Task.Delay(1000);
            CurrentPhase = ScenarioPhase.Completed;
            StateHasChanged();

            await Task.Delay(1000);
            await Scenario.MarkScenario(1, completed: true);
            await JS.InvokeVoidAsync("history.back");
        }
    }

    async Task Glitch()
    {
        CurrentPhase = ScenarioPhase.Glitch;
        StateHasChanged();

        await Task.Delay(500);
        _ = Audio.Speak("sc1-speech", "Dit is een lichte variatie binnen de toegestane marges. Noteer afwijking als niet‑kritiek.", duration: 6000);

        for (var i = 0; i < 6; i++)
        {
            TearClass = $"tear-{Random.Shared.Next(1, 6)}";
            StateHasChanged();
            await Task.Delay(Random.Shared.Next(30, 80));
            
            TearClass = null;
            StateHasChanged();
            await Task.Delay(Random.Shared.Next(20, 60));
        }
    }
}
